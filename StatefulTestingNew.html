<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Model-based Testing (Experimental)
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="FsCheck is a tool for testing .NET programs automatically using randomly generated test cases."/>
    <meta name="author" content="Kurt Schelfthout and contributors"/>

    <script src="https://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="https://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet"/>

    <link type="text/css" rel="stylesheet" href="/FsCheck/content/style.css" />
    <script type="text/javascript" src="/FsCheck/content/tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="https://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="http://github.com/fscheck/FsCheck/fork">Fork me on GitHub</a></li>
        </ul>
        <h3 class="muted"><a href="/FsCheck/index.html">FsCheck</a></h3>
      </div>
      <hr />
      <div class="row">
        <div class="span9" id="main">
          
<h1><a name="Model-based-Testing-Experimental" class="anchor" href="#Model-based-Testing-Experimental">Model-based Testing (Experimental)</a></h1>
<p>There is also a newer, experimental interface to do model-based testing.</p>
<p><em>Caveat: since this is in the FsCheck.Experimental namespace for now, the rules of semantic versioning do
not apply to this particular part of the API. In other words, minor version releases may break your code.</em></p>
<p>Let's look at the following simple class, which has an artificial bug:</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">type</span> <span class="i">Counter</span>(<span class="o">?</span><span class="i">initial</span><span class="o">:</span><span class="i">int</span>) <span class="o">=</span>
    <span class="k">let</span> <span class="k">mutable</span> <span class="i">n</span> <span class="o">=</span> <span class="i">defaultArg</span> <span class="i">initial</span> <span class="n">0</span>
    <span class="k">member</span> <span class="i">__</span><span class="o">.</span><span class="i">Inc</span>() <span class="o">=</span> 
        <span class="c">//silly bug</span>
        <span class="k">if</span> <span class="i">n</span> <span class="o">&lt;=</span> <span class="n">3</span>  <span class="k">then</span> <span class="i">n</span> <span class="o">&lt;-</span> <span class="i">n</span> <span class="o">+</span> <span class="n">1</span> <span class="k">else</span> <span class="i">n</span> <span class="o">&lt;-</span> <span class="i">n</span> <span class="o">+</span> <span class="n">2</span>
        <span class="i">n</span>
    <span class="k">member</span> <span class="i">__</span><span class="o">.</span><span class="i">Dec</span>() <span class="o">=</span> <span class="k">if</span> <span class="i">n</span> <span class="o">&lt;=</span> <span class="n">0</span> <span class="k">then</span> <span class="i">failwithf</span> <span class="s">&quot;Precondition fail&quot;</span> <span class="k">else</span> <span class="i">n</span> <span class="o">&lt;-</span> <span class="i">n</span> <span class="o">-</span> <span class="n">1</span>; <span class="i">n</span>
    <span class="k">member</span> <span class="i">__</span><span class="o">.</span><span class="i">Reset</span>() <span class="o">=</span> <span class="i">n</span> <span class="o">&lt;-</span> <span class="n">0</span>
    <span class="k">override</span> <span class="i">__</span><span class="o">.</span><span class="i">ToString</span>() <span class="o">=</span> <span class="i">sprintf</span> <span class="s">&quot;Counter = %i&quot;</span> <span class="i">n</span>
</code></pre>
<p>As a model to test this class we can use an int value which is an abstraction of the object's internal state. The
idea is that each operation on the class (in this case, Inc, Dec and Reset) affects both the model object and the actual object, and
after each such operation, the model and the actual instance should still be equivalent.</p>
<p>With this idea in mind, you can write a specification of the Counter class using an int model as follows:</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">spec</span> <span class="o">=</span>
    <span class="k">let</span> <span class="i">inc</span> <span class="o">=</span> 
        { <span class="k">new</span> <span class="i">Operation</span><span class="o">&lt;</span><span class="i">Counter</span>,<span class="i">int</span><span class="o">&gt;</span>() <span class="k">with</span>
            <span class="k">member</span> <span class="i">__</span><span class="o">.</span><span class="i">Run</span> <span class="i">m</span> <span class="o">=</span> <span class="i">m</span> <span class="o">+</span> <span class="n">1</span>
            <span class="k">member</span> <span class="i">__</span><span class="o">.</span><span class="i">Check</span> (<span class="i">c</span>,<span class="i">m</span>) <span class="o">=</span> 
                <span class="k">let</span> <span class="i">res</span> <span class="o">=</span> <span class="i">c</span><span class="o">.</span><span class="i">Inc</span>() 
                <span class="i">m</span> <span class="o">=</span> <span class="i">res</span> 
                <span class="o">|@</span> <span class="i">sprintf</span> <span class="s">&quot;Inc: model = %i, actual = %i&quot;</span> <span class="i">m</span> <span class="i">res</span>
            <span class="k">override</span> <span class="i">__</span><span class="o">.</span><span class="i">ToString</span>() <span class="o">=</span> <span class="s">&quot;inc&quot;</span>}
    <span class="k">let</span> <span class="i">dec</span> <span class="o">=</span> 
        { <span class="k">new</span> <span class="i">Operation</span><span class="o">&lt;</span><span class="i">Counter</span>,<span class="i">int</span><span class="o">&gt;</span>() <span class="k">with</span>
            <span class="k">member</span> <span class="i">__</span><span class="o">.</span><span class="i">Run</span> <span class="i">m</span> <span class="o">=</span> <span class="i">m</span> <span class="o">-</span> <span class="n">1</span>
            <span class="k">override</span> <span class="i">__</span><span class="o">.</span><span class="i">Pre</span> <span class="i">m</span> <span class="o">=</span> 
                <span class="i">m</span> <span class="o">&gt;</span> <span class="n">0</span>
            <span class="k">member</span> <span class="i">__</span><span class="o">.</span><span class="i">Check</span> (<span class="i">c</span>,<span class="i">m</span>) <span class="o">=</span> 
                <span class="k">let</span> <span class="i">res</span> <span class="o">=</span> <span class="i">c</span><span class="o">.</span><span class="i">Dec</span>()
                <span class="i">m</span> <span class="o">=</span> <span class="i">res</span> 
                <span class="o">|@</span> <span class="i">sprintf</span> <span class="s">&quot;Dec: model = %i, actual = %i&quot;</span> <span class="i">m</span> <span class="i">res</span>
            <span class="k">override</span> <span class="i">__</span><span class="o">.</span><span class="i">ToString</span>() <span class="o">=</span> <span class="s">&quot;dec&quot;</span>}
    <span class="k">let</span> <span class="i">create</span> <span class="i">initialValue</span> <span class="o">=</span> 
        { <span class="k">new</span> <span class="i">Setup</span><span class="o">&lt;</span><span class="i">Counter</span>,<span class="i">int</span><span class="o">&gt;</span>() <span class="k">with</span>
            <span class="k">member</span> <span class="i">__</span><span class="o">.</span><span class="i">Actual</span>() <span class="o">=</span> <span class="k">new</span> <span class="i">Counter</span>(<span class="i">initialValue</span>)
            <span class="k">member</span> <span class="i">__</span><span class="o">.</span><span class="i">Model</span>() <span class="o">=</span> <span class="i">initialValue</span> }
    { <span class="k">new</span> <span class="i">Machine</span><span class="o">&lt;</span><span class="i">Counter</span>,<span class="i">int</span><span class="o">&gt;</span>() <span class="k">with</span>
        <span class="k">member</span> <span class="i">__</span><span class="o">.</span><span class="i">Setup</span> <span class="o">=</span> <span class="i">Gen</span><span class="o">.</span><span class="i">choose</span> (<span class="n">0</span>,<span class="n">3</span>) <span class="o">|&gt;</span> <span class="i">Gen</span><span class="o">.</span><span class="i">map</span> <span class="i">create</span> <span class="o">|&gt;</span> <span class="i">Arb</span><span class="o">.</span><span class="i">fromGen</span>
        <span class="k">member</span> <span class="i">__</span><span class="o">.</span><span class="i">Next</span> _ <span class="o">=</span> <span class="i">Gen</span><span class="o">.</span><span class="i">elements</span> [ <span class="i">inc</span>; <span class="i">dec</span> ] }
</code></pre>
<p>Let's break this down a bit. A specification is put together as an object that is a subtype of the abstract class <code>Machine&lt;'TypeUnderTest,'ModelType&gt;</code>.
What you're actually defining is a state machine which can simultaneously apply operations, or state transitions, to the actual system
under test (in this case, a simple object) and a model of the system under test.</p>
<p>The methods you override on <code>Machine</code> are <code>Setup</code>, <code>Next</code>, and optionally <code>TearDown</code>.</p>
<p><code>Machine.Setup</code> is a property that returns an <code>Arbitrary</code> instance that generates (and optionally shrinks) a <code>Setup&lt;'TypeUnderTest, 'ModelType&gt;</code> object. This in turn has two methods
to override: <code>Actual()</code> which should return a new, fresh instance of the system under test every time it is called, and <code>Model()</code> which should return the corresponding
instance of the model object each time it is called. In the example, there is only one subclass of <code>Setup&lt;'Counter,int&gt;</code> (in more complex cases, there might be more). Our
<code>Setup</code> instance takes as argument the initial counter value, and returns a fresh <code>Counter</code> as the SUT. The model is in this case simply the initial value.</p>
<p><code>Machine.Next</code> is a method that takes a model and generates the possible operations that are possible from the state represented by the model. Each operation
is represented by an <code>Operation</code> subclass.</p>
<p><code>Operation</code> has three methods to override: <code>Run</code>, <code>Check</code> and optionally <code>Pre</code>. <code>Pre</code> takes a model and returns true
if and only if this operation can execute on a model in that state - in other words it checks if the precondition for the operation is satisfied. Note that
<code>Machine.Next</code> can also return a reduced set of operations based on the model, which is more efficient, but the preconditions are checked regardless for each
operation <code>Next</code> generates.</p>
<p><code>Run</code> takes a model and returns the new model which is the result of applying this operation to the model. <code>Check</code> then takes the new model (as returned from <code>Run</code>),
applies the operation to the actual system under test, and checks whether the result of the SUT matches with the model. The return type of <code>Check</code> is Property so
you can use the usual FsCheck <code>Prop</code> methods to implement this method.</p>
<p>In the example above there are only two operations that we're checking: <code>Inc</code> and <code>Dec</code>. The <code>Run</code> methods respectively increase and decrease the model. <code>Check</code>
calls <code>Inc()</code> or <code>Dec()</code> on the <code>Counter</code> instance, and checks that after that the model counter is equal to the real <code>Counter</code>. <code>Dec</code> in addition has a (quite
silly, for demonstration purposes) precondition that the value should be strictly greater than 0 - if we run this machine our <code>Counter</code> throws if we call <code>Dec</code>
so when we run this specification we can check that FsCheck does the right thing here (testing the test library, very meta...)</p>
<p>We also override ToString in each <code>Operation</code> so that counter-examples can be printed.</p>
<p>A specification can be checked as follows:</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="i">Check</span><span class="o">.</span><span class="i">Quick</span> (<span class="i">StateMachine</span><span class="o">.</span><span class="i">toProperty</span> <span class="i">spec</span>)
</code></pre>
<table class="pre"><tr><td><pre><code>Falsifiable, after 7 tests (6 shrinks) (StdGen (1905036347,296298887)):
Label of failing property: Inc: model = 5, actual = 6
Original:
(3, Setup Counter)
inc -&gt; 4
dec -&gt; 3
inc -&gt; 4
inc -&gt; 5
inc -&gt; 6
dec -&gt; 5
dec -&gt; 4
dec -&gt; 3

Shrunk:
(3, Setup Counter)
inc -&gt; 4
inc -&gt; 5</code></pre></td></tr></table>
<p>Notice that not only has FsCheck found our 'bug', it has also produced the minimal sequence of operations that leads to it.</p>
<p>But what has actually happened? Using the generators from the <code>Machine</code> methods, FsCheck tries to generate a random sequence of operations, for example:</p>
<pre class="fssnip highlighted"><code lang="fsharp">{<span class="i">Setup</span> <span class="o">=</span> (<span class="n">0</span>, <span class="i">Setup</span> <span class="i">Counter</span>);
 <span class="i">Operations</span> <span class="o">=</span>
  [(<span class="i">inc</span>, <span class="n">1</span>); (<span class="i">dec</span>, <span class="n">0</span>); (<span class="i">inc</span>, <span class="n">1</span>); (<span class="i">inc</span>, <span class="n">2</span>); (<span class="i">inc</span>, <span class="n">3</span>); (<span class="i">inc</span>, <span class="n">4</span>); (<span class="i">inc</span>, <span class="n">5</span>);
   (<span class="i">dec</span>, <span class="n">4</span>); (<span class="i">dec</span>, <span class="n">3</span>)];
 <span class="i">TearDown</span> <span class="o">=</span> <span class="i">TearDown</span> <span class="i">Counter</span>;}
</code></pre>
<p>You can read this as a trace of the operations: the counter started off in state <code>0</code>, then using operation <code>inc</code> when to state <code>1</code>, then using operation <code>dec</code>
went to state <code>0</code> and so on.</p>
<p>This sequence is first generated using the model only, i.e. no operations are actually applied to any <code>Counter</code> objects. After generating a full trace, the operations
are actually applied to the system under test, using the <code>Operation.Check</code> methods of the various <code>Operation</code> objects.</p>
<p>If a failing test is found, FsCheck will attempt to remove operations from the sequence of operations, as long as the test still fails. So in the example above,
although the original sequence contains a few superfluous operations, FsCheck normally finds a shorter if not the shortest sequence that leads to the failure.</p>


        </div>
        <div class="span3">
          <img src="/FsCheck/img/logo.png" alt="F# Project" style="width:150px;margin:10px" />  
          <ul class="nav nav-list" id="menu" style="margin-top: 20px;">
            <li class="nav-header">FsCheck</li>
            <li><a href="/FsCheck/index.html">Home page</a></li>
            <li class="divider"></li>
            <li><a href="http://nuget.org/packages/FsCheck">Get Library via NuGet</a></li>
            <li><a href="http://github.com/fscheck/FsCheck">Source Code on GitHub</a></li>
            <li><a href="http://github.com/fscheck/FsCheck/blob/master/License.txt">License</a></li>
            <li><a href="http://github.com/fscheck/FsCheck/blob/master/FsCheck Release Notes.md">Release Notes</a></li>
            <li><a href="/FsCheck/users.html">Who is using FsCheck?</a></li>
            
            <li class="nav-header">Getting started</li>
            <li><a href="/FsCheck/QuickStart.html">Quick Start</a></li>
            <li><a href="/FsCheck/LearningResources.html">Learning Resources</a></li>

            <li class="nav-header">Documentation</li>
            <li>
              <a href="/FsCheck/Properties.html">Properties</a>
            </li>
            <li>
              <a href="/FsCheck/TestData.html">Generating test data</a>
            </li>
            <li>
              <a href="/FsCheck/StatefulTesting.html">Model-based testing</a>
            </li>
            <li>
              <a href="/FsCheck/RunningTests.html">Running tests</a>
            </li>
            <li>
              <a href="/FsCheck/TipsAndTricks.html">Tips and Tricks</a>
            </li>
              <li>
                  <a href="/FsCheck/StatefulTestingNew.html">Model-based testing vNext (Experimental)</a>
              </li>

            <li><a href="/FsCheck/reference/index.html">API Reference</a></li>
          </ul>
        </div>
      </div>
    </div>
    <a href="http://github.com/fscheck/FsCheck">
      <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"/>
    </a>
  </body>
  </html>
