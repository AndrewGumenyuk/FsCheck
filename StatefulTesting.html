<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Model-based Testing
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="FsCheck is a tool for testing .NET programs automatically using randomly generated test cases."/>
    <meta name="author" content="Kurt Schelfthout and contributors"/>

    <script src="https://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="https://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet"/>

    <link type="text/css" rel="stylesheet" href="/FsCheck/content/style.css" />
    <script type="text/javascript" src="/FsCheck/content/tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="https://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="http://github.com/fscheck/FsCheck/fork">Fork me on GitHub</a></li>
        </ul>
        <h3 class="muted"><a href="/FsCheck/index.html">FsCheck</a></h3>
      </div>
      <hr />
      <div class="row">
        <div class="span9" id="main">
          
<h1><a name="Model-based-Testing" class="anchor" href="#Model-based-Testing">Model-based Testing</a></h1>
<p>FsCheck also allows you to test objects, which usually encapsulate internal
state through a set of methods. FsCheck, through small extension,
allows you to do model-based specification of a class under test. Consider the following class,
with an artificial bug in it:</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">type</span> <span class="i">Counter</span>() <span class="o">=</span>
  <span class="k">let</span> <span class="k">mutable</span> <span class="i">n</span> <span class="o">=</span> <span class="n">0</span>
  <span class="k">member</span> <span class="i">__</span><span class="o">.</span><span class="i">Inc</span>() <span class="o">=</span> <span class="i">n</span> <span class="o">&lt;-</span> <span class="i">n</span> <span class="o">+</span> <span class="n">1</span>
  <span class="k">member</span> <span class="i">__</span><span class="o">.</span><span class="i">Dec</span>() <span class="o">=</span> <span class="k">if</span> <span class="i">n</span> <span class="o">&gt;</span> <span class="n">2</span> <span class="k">then</span> <span class="i">n</span> <span class="o">&lt;-</span> <span class="i">n</span> <span class="o">-</span> <span class="n">2</span> <span class="k">else</span> <span class="i">n</span> <span class="o">&lt;-</span> <span class="i">n</span> <span class="o">-</span> <span class="n">1</span>
  <span class="k">member</span> <span class="i">__</span><span class="o">.</span><span class="i">Get</span> <span class="o">=</span> <span class="i">n</span>
  <span class="k">member</span> <span class="i">__</span><span class="o">.</span><span class="i">Reset</span>() <span class="o">=</span> <span class="i">n</span> <span class="o">&lt;-</span> <span class="n">0</span>
  <span class="k">override</span> <span class="i">__</span><span class="o">.</span><span class="i">ToString</span>() <span class="o">=</span> <span class="i">sprintf</span> <span class="s">&quot;Counter=%i&quot;</span> <span class="i">n</span>
</code></pre>
<p>We'll elide the class definition in C#, it's very similar.</p>
<p>As a model to test this class we can use an int value which is an abstraction of the object's internal state. The
idea is that each operation on the class (in this case, Inc and Dec) affects both the model and the actual object, and
after each such operation, the model and the actual instance should still be equivalent.</p>
<p>With this idea in mind, you can write a specification of the Counter class using an int model as follows (full example
in C# below):</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">spec</span> <span class="o">=</span>
  <span class="k">let</span> <span class="i">inc</span> <span class="o">=</span> { <span class="k">new</span> <span class="i">Command</span><span class="o">&lt;</span><span class="i">Counter</span>, <span class="i">int</span><span class="o">&gt;</span>() <span class="k">with</span>
                    <span class="k">override</span> <span class="i">__</span><span class="o">.</span><span class="i">RunActual</span> <span class="i">counter</span> <span class="o">=</span> <span class="i">counter</span><span class="o">.</span><span class="i">Inc</span>(); <span class="i">counter</span>
                    <span class="k">override</span> <span class="i">__</span><span class="o">.</span><span class="i">RunModel</span> <span class="i">m</span> <span class="o">=</span> <span class="i">m</span> <span class="o">+</span> <span class="n">1</span>
                    <span class="k">override</span> <span class="i">__</span><span class="o">.</span><span class="i">Post</span>(<span class="i">counter</span>, <span class="i">m</span>) <span class="o">=</span> <span class="i">counter</span><span class="o">.</span><span class="i">Get</span> <span class="o">=</span> <span class="i">m</span> <span class="o">|@</span> <span class="i">sprintf</span> <span class="s">&quot;model: %i &lt;&gt; %A&quot;</span> <span class="i">m</span> <span class="i">counter</span>
                    <span class="k">override</span> <span class="i">__</span><span class="o">.</span><span class="i">ToString</span>() <span class="o">=</span> <span class="s">&quot;inc&quot;</span> }
                           
  <span class="k">let</span> <span class="i">dec</span> <span class="o">=</span> { <span class="k">new</span> <span class="i">Command</span><span class="o">&lt;</span><span class="i">Counter</span>, <span class="i">int</span><span class="o">&gt;</span>() <span class="k">with</span>
                    <span class="k">override</span> <span class="i">__</span><span class="o">.</span><span class="i">RunActual</span> <span class="i">counter</span> <span class="o">=</span> <span class="i">counter</span><span class="o">.</span><span class="i">Dec</span>(); <span class="i">counter</span>
                    <span class="k">override</span> <span class="i">__</span><span class="o">.</span><span class="i">RunModel</span> <span class="i">m</span> <span class="o">=</span> <span class="i">m</span> <span class="o">-</span> <span class="n">1</span>
                    <span class="k">override</span> <span class="i">__</span><span class="o">.</span><span class="i">Post</span>(<span class="i">counter</span>, <span class="i">m</span>) <span class="o">=</span> <span class="i">counter</span><span class="o">.</span><span class="i">Get</span> <span class="o">=</span> <span class="i">m</span> <span class="o">|@</span> <span class="i">sprintf</span> <span class="s">&quot;model: %i &lt;&gt; %A&quot;</span> <span class="i">m</span> <span class="i">counter</span>
                    <span class="k">override</span> <span class="i">__</span><span class="o">.</span><span class="i">ToString</span>() <span class="o">=</span> <span class="s">&quot;dec&quot;</span> }
  
  { <span class="k">new</span> <span class="i">ICommandGenerator</span><span class="o">&lt;</span><span class="i">Counter</span>,<span class="i">int</span><span class="o">&gt;</span> <span class="k">with</span>
      <span class="k">member</span> <span class="i">__</span><span class="o">.</span><span class="i">InitialActual</span> <span class="o">=</span> <span class="i">Counter</span>()
      <span class="k">member</span> <span class="i">__</span><span class="o">.</span><span class="i">InitialModel</span> <span class="o">=</span> <span class="n">0</span>
      <span class="k">member</span> <span class="i">__</span><span class="o">.</span><span class="i">Next</span> <span class="i">model</span> <span class="o">=</span> <span class="i">Gen</span><span class="o">.</span><span class="i">elements</span> [<span class="i">inc</span>;<span class="i">dec</span>] }
</code></pre>
<p>A specification is put together for FsCheck as an object that implementents <code>ICommandGenerator&lt;'typeUnderTest,'modelType&gt;</code>. It should return
an initial object and an initial model of that object; and it should return a generator of <code>Command</code> objects.</p>
<p>Each <code>Command</code> typically represents one method to call on the object under test, and describes what
happens to the model and the object when the command is executed. Also, it can assert preconditions that
need to hold before executing the command: FsCheck will not execute that command if the precondition does
not hold. It asserts postconditions that should hold after a command is executed: FsCheck
fails the test if a postcondition does not hold.</p>
<p>Preferably also override ToString in each command so that counterexamples can be printed.</p>
<p>A specification can be checked as follows:</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="i">Check</span><span class="o">.</span><span class="i">Quick</span> (<span class="i">Command</span><span class="o">.</span><span class="i">toProperty</span> <span class="i">spec</span>)
</code></pre>
<table class="pre"><tr><td><pre><code>Falsifiable, after 5 tests (2 shrinks) (StdGen (1377688794,296298921)):
Label of failing property: model: 2 &lt;&gt; Counter=1
Original:
[inc; inc; inc; dec; inc; inc]
Shrunk:
[inc; inc; inc; dec]</code></pre></td></tr></table>
<p>Notice that not only has FsCheck found our 'bug', it has also produced the minimal sequence that leads to it.</p>
<p>Finally, in C#, all this looks as follows:</p>
<table class="pre"><tr><td class="snippet"><pre class="fssnip highlighted"><code lang="csharp"><span class="k">public</span> <span class="k">class</span> CounterSpec <span class="o">:</span> ICommandGenerator&lt;Counter, <span class="k">int</span>&gt; {

    <span class="k">public</span> Gen&lt;Command&lt;Counter, <span class="k">int</span>&gt;<span class="o">&gt;</span> Next(<span class="k">int</span> <span class="k">value</span>) {
        <span class="k">return</span> Gen.Elements(<span class="k">new</span> Command&lt;Counter, <span class="k">int</span>&gt;[] { <span class="k">new</span> Inc(), <span class="k">new</span> Dec() });
    }

    <span class="k">public</span> Counter InitialActual { get { <span class="k">return</span> <span class="k">new</span> Counter(); } }

    <span class="k">public</span> <span class="k">int</span> InitialModel { get { <span class="k">return</span> <span class="n">0</span>; } }

    <span class="k">private</span> <span class="k">class</span> Inc <span class="o">:</span> Command&lt;Counter,<span class="k">int</span>&gt; {
        <span class="k">public</span> <span class="k">override</span> Counter RunActual(Counter c) {
            c.Inc();
            <span class="k">return</span> c;
        }

        <span class="k">public</span> <span class="k">override</span> <span class="k">int</span> RunModel(<span class="k">int</span> m) {
            <span class="k">return</span> m <span class="o">+</span> <span class="n">1</span>;
        }

        <span class="k">public</span> <span class="k">override</span> Property Post(Counter c, <span class="k">int</span> m) {
            <span class="k">return</span> (m <span class="o">=</span><span class="o">=</span> c.Get()).ToProperty();
        }

        <span class="k">public</span> <span class="k">override</span> <span class="k">string</span> ToString() {
            <span class="k">return</span> <span class="s">"inc"</span>;
        }
    }

    <span class="k">private</span> <span class="k">class</span> Dec <span class="o">:</span> Command&lt;Counter,<span class="k">int</span>&gt;{
        <span class="k">public</span> <span class="k">override</span> Counter RunActual(Counter c) {
            c.Dec();
            <span class="k">return</span> c;
        }

        <span class="k">public</span> <span class="k">override</span> <span class="k">int</span> RunModel(<span class="k">int</span> m) {
            <span class="k">return</span> m <span class="o">-</span> <span class="n">1</span>;
        }

        <span class="k">public</span> <span class="k">override</span> Property Post(Counter c, <span class="k">int</span> m) {
            <span class="k">return</span> (m <span class="o">=</span><span class="o">=</span> c.Get()).ToProperty();
        }

        <span class="k">public</span> <span class="k">override</span> <span class="k">string</span> ToString() {
            <span class="k">return</span> <span class="s">"dec"</span>;
        }
    }
}</code></pre></td></tr></table>
<p>And to run:</p>
<table class="pre"><tr><td class="snippet"><pre class="fssnip highlighted"><code lang="csharp"><span class="k">new</span> CounterSpec()
    .ToProperty()
    .QuickCheck();</code></pre></td></tr></table>


        </div>
        <div class="span3">
          <img src="/FsCheck/img/logo.png" alt="F# Project" style="width:150px;margin:10px" />  
          <ul class="nav nav-list" id="menu" style="margin-top: 20px;">
            <li class="nav-header">FsCheck</li>
            <li><a href="/FsCheck/index.html">Home page</a></li>
            <li class="divider"></li>
            <li><a href="http://nuget.org/packages/FsCheck">Get Library via NuGet</a></li>
            <li><a href="http://github.com/fscheck/FsCheck">Source Code on GitHub</a></li>
            <li><a href="http://github.com/fscheck/FsCheck/blob/master/License.txt">License</a></li>
            <li><a href="http://github.com/fscheck/FsCheck/blob/master/FsCheck Release Notes.md">Release Notes</a></li>
            <li><a href="/FsCheck/users.html">Who is using FsCheck?</a></li>
            
            <li class="nav-header">Getting started</li>
            <li><a href="/FsCheck/QuickStart.html">Quick Start</a></li>
            <li><a href="/FsCheck/LearningResources.html">Learning Resources</a></li>

            <li class="nav-header">Documentation</li>
            <li>
              <a href="/FsCheck/Properties.html">Properties</a>
            </li>
            <li>
              <a href="/FsCheck/TestData.html">Generating test data</a>
            </li>
            <li>
              <a href="/FsCheck/StatefulTesting.html">Model-based testing</a>
            </li>
            <li>
              <a href="/FsCheck/RunningTests.html">Running tests</a>
            </li>
            <li>
              <a href="/FsCheck/TipsAndTricks.html">Tips and Tricks</a>
            </li>
              <li>
                  <a href="/FsCheck/StatefulTestingNew.html">Model-based testing vNext (Experimental)</a>
              </li>

            <li><a href="/FsCheck/reference/index.html">API Reference</a></li>
          </ul>
        </div>
      </div>
    </div>
    <a href="http://github.com/fscheck/FsCheck">
      <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"/>
    </a>
  </body>
  </html>
